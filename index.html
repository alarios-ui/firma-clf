<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firma Digital - Café Las Flores</title>
  <link rel="icon" href="assets/header-cafe.png">
  <meta name="theme-color" content="#3b2f2f">
  <meta name="description" content="Generador de firma digital — Café Las Flores">
  <style>
    :root{ --border:#e5e7eb; --text:#111827; --muted:#6b7280; --bg:#ffffff; --soft:#f9fafb; }

    /* Fondo con GIF animado */
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:0;
      color:#111827;

      background-image: url("assets/bg-cafe.gif");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: scroll; /* mejor para GIF y móviles */
    }
    /* Accesibilidad: si el usuario pide menos movimiento, usar imagen estática */
    @media (prefers-reduced-motion: reduce){
      body{
        background-image: url("assets/bg-cafe.png");
      }
    }

    .page-overlay{
      min-height:100vh;
      background: rgba(0,0,0,0.32); /* un poco más oscuro para contraste */
    }

    .wrap{max-width:980px; margin:0 auto; padding:18px 16px 28px;}
    h1{
      margin:0 0 10px;
      font-size:34px;
      font-weight:800;
      color:#ffffff;
      text-shadow:
        0 0 4px rgba(255,255,255,0.6),
        0 0 10px rgba(255,255,255,0.35),
        1px 1px 2px rgba(0,0,0,0.8);
    }
    .headerImg{margin:6px 0 18px;}
    .headerImg img{max-height:78px; width:auto; display:block;}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:18px; align-items:start;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }

    .card{border:1px solid var(--border); border-radius:14px; padding:16px; background:var(--soft);}
    .card h2{margin:0 0 12px; font-size:16px;}

    .form{display:grid; gap:10px;}

    .row{
      display:grid;
      grid-template-columns: 120px 300px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }
    label{font-weight:700; font-size:13px;}
    input{
      width:300px;
      max-width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      display:block;
      justify-self:start;
    }
    input[readonly]{background:#f3f4f6; color:#374151;}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:1px solid var(--border); background:#fff;
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;
    }
    button.primary{background:#111827; color:#fff; border-color:#111827;}

    /* Teléfono con prefijo fijo */
    .phoneWrap{display:flex; gap:8px; align-items:center; width:300px; max-width:100%;}
    .phonePrefix{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:#f3f4f6;
      color:#374151;
      font-size:14px;
      white-space:nowrap;
    }
    .phoneWrap input{flex:1; min-width:0; width:auto;}

    /* Firma (preview) */
    .sigWrap{border:1px dashed #cbd5e1; border-radius:14px; padding:14px; background:#fff;}
    .firmaPreview{
      width:100%;
      display:flex; gap:14px; align-items:center;
      background:#fff;
    }
    .sigLeft{flex:1; min-width:220px;}
    .sigName{font-size:22px; font-weight:800; margin:0 0 2px;}
    .sigRole{font-size:14px; margin:0 0 10px; color:#111827;}
    .sigPhone{font-size:14px; font-weight:800; margin:0 0 2px;}
    .sigWeb a{color:#0b57d0; font-weight:800; text-decoration:none;}
    .sigAddr{font-size:13px; color:#374151; margin-top:10px; line-height:1.35;}
    .sigRight{width:220px; display:flex; justify-content:flex-end; align-items:center;}
    .sigRight img{max-width:220px; height:auto; display:block;}

    .captureHost{
      position:fixed;
      left:-10000px;
      top:0;
      background:#fff;
      padding:0;
      margin:0;
      z-index:-1;
    }

    /* === Modal requerido === */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      background:#fff; border-radius:14px; padding:18px; width:calc(100% - 32px);
      max-width:420px; box-shadow:0 10px 25px rgba(0,0,0,.2); border:1px solid var(--border);
    }
    .modal h3{ margin:0 0 8px; font-size:18px; }
    .modal p{ margin:0 0 14px; color:#374151; }
    .modal .actions{ display:flex; justify-content:flex-end; gap:8px; }

    /* Error visual en inputs obligatorios */
    .input-error{ border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
  </style>
</head>

<body>
  <div class="page-overlay">
    <div class="wrap">
      <h1>Genera tu Firma Digital</h1>

      <div class="headerImg">
        <img src="assets/header-cafe.png" alt="Café Las Flores">
      </div>

      <div class="grid">
        <div class="card">
          <h2>Datos</h2>

          <div class="form" id="form">
            <div class="row">
              <label for="nombre">Nombre</label>
              <input id="nombre" placeholder="Ej: Larry Larios" maxlength="60" />
            </div>

            <div class="row">
              <label for="cargo">Cargo</label>
              <input id="cargo" placeholder="Ej: Especialista de Soporte Técnico" maxlength="80" />
            </div>

            <div class="row">
              <label for="telefono_num">Teléfono</label>
              <div class="phoneWrap">
                <div class="phonePrefix">+(505)</div>
                <input id="telefono_num" placeholder="Ej: 5764 9650" maxlength="25" inputmode="numeric" />
              </div>
            </div>

            <div class="row">
              <label for="web">Sitio Web</label>
              <input id="web" value="https://cafelasflores.com/" readonly />
            </div>

            <div class="row">
              <label for="direccion">Dirección</label>
              <input id="direccion" placeholder="Ej: Km. 13.1 Carretera Masaya ... Managua" maxlength="140" />
            </div>

            <div class="actions">
              <button class="primary" id="btnGenerar" type="button" aria-label="Generar vista previa">Generar</button>
              <button id="btnLimpiar" type="button">Limpiar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Vista previa</h2>
          <div class="sigWrap">
            <div id="sigPreview"></div>
          </div>

          <div class="actions">
            <button class="primary" id="btnDescargarPng" type="button">Descargar firma</button>
            <button id="btnGmail" type="button">Configura tu firma</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: campos incompletos (antes de los scripts para asegurar que exista en el DOM) -->
  <div id="reqModal" class="modal-backdrop" role="dialog" aria-modal="true"
       aria-labelledby="reqTitle" aria-describedby="reqDesc">
    <div class="modal">
      <h3 id="reqTitle">Campos incompletos</h3>
      <p id="reqDesc">Para generar la firma, completá <b>Nombre, Cargo, Teléfono y Dirección</b>.</p>
      <div class="actions">
        <button id="reqClose" class="primary" type="button" aria-label="Cerrar aviso">Entendido</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const LOGO_PNG_URL = "assets/header-cafe.png"; /* usa el logo que prefieras */
    const PHONE_PREFIX = "+(505)";
    const $ = (id) => document.getElementById(id);

    function esc(s){
      return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function normalizePhone(num){ return (num || "").trim(); }

    function getData(){
      const phoneNum = normalizePhone($("telefono_num").value);
      return {
        nombre: $("nombre").value.trim(),
        cargo: $("cargo").value.trim(),
        telefonoNum: phoneNum,
        telefono: phoneNum ? `${PHONE_PREFIX} ${phoneNum}` : "",
        web: $("web").value.trim(),
        direccion: $("direccion").value.trim(),
      };
    }

    // Firma compacta en modo captura (sin márgenes extra)
    function buildFirmaHTML(data, fixedWidth){
      const isCapture = !!fixedWidth;
      const baseStyle = isCapture
        ? "display:inline-flex;gap:14px;align-items:center;background:#fff;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;"
        : "width:100%;display:flex;gap:14px;align-items:center;background:#fff;";
      const leftStyle = isCapture
        ? "flex:0 1 auto;min-width:220px;max-width:520px;"
        : "flex:1;min-width:220px;";
      return `
        <div class="${isCapture ? "" : "firmaPreview"}" style="${baseStyle}">
          <div class="sigLeft" style="${leftStyle}">
            <div class="sigName" style="font-size:22px;font-weight:800;margin:0 0 2px;">${esc(data.nombre)}</div>
            <div class="sigRole" style="font-size:14px;margin:0 0 10px;color:#111827;">${esc(data.cargo)}</div>
            <div class="sigPhone" style="font-size:14px;font-weight:800;margin:0 0 2px;">${esc(data.telefono)}</div>
            <div class="sigWeb">
              <a href="${esc(data.web)}" style="color:#0b57d0;font-weight:800;text-decoration:none;">${esc(data.web)}</a>
            </div>
            <div class="sigAddr" style="font-size:13px;color:#374151;margin-top:10px;line-height:1.35;">${esc(data.direccion)}</div>
          </div>
          <div class="sigRight" style="width:220px;display:flex;justify-content:flex-end;align-items:center;">
            <img src="${esc(LOGO_PNG_URL)}" alt="Café Las Flores" style="max-width:220px;height:auto;display:block;" />
          </div>
        </div>
      `.trim();
    }

    // --- Modal: abrir/cerrar + fallback ---
    function openReqModal(){
      const m = $("reqModal");
      const btn = $("reqClose");
      if(!m || !btn){
        alert("Para generar la firma, completá Nombre, Cargo, Teléfono y Dirección.");
        return;
      }
      m.classList.add("open");
      try { btn.focus(); } catch(e){}
    }
    function closeReqModal(){
      const m = $("reqModal");
      if(m) m.classList.remove("open");
    }
    // Listeners del modal
    (function(){
      const m = $("reqModal");
      const btn = $("reqClose");
      if(btn) btn.addEventListener("click", closeReqModal);
      if(m)   m.addEventListener("click", (e)=>{ if(e.target.id === "reqModal") closeReqModal(); });
      document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeReqModal(); });
    })();

    // Render de vista previa con validación visual
    function renderPreview(){
      const data = getData();

      ["nombre","cargo","telefono_num","direccion"].forEach(id => $(id).classList.remove("input-error"));
      let firstMissing = null;
      if(!data.nombre) firstMissing = firstMissing || "nombre";
      if(!data.cargo) firstMissing = firstMissing || "cargo";
      if(!data.telefonoNum) firstMissing = firstMissing || "telefono_num";
      if(!data.direccion) firstMissing = firstMissing || "direccion";

      if(firstMissing){
        $(firstMissing).classList.add("input-error");
        $(firstMissing).focus();
        $("sigPreview").innerHTML = `<div style="color:#6b7280;font-size:13px;">Completa <b>Nombre, Cargo, Teléfono y Dirección</b> y presiona “Generar”.</div>`;
        openReqModal();
        return false;
      }
      $("sigPreview").innerHTML = buildFirmaHTML(data, false);
      return true;
    }

    // Listeners principales
    $("btnGenerar").addEventListener("click", renderPreview);
    $("btnLimpiar").addEventListener("click", ()=>{
      $("nombre").value = "";
      $("cargo").value = "";
      $("telefono_num").value = "";
      $("direccion").value = "";
      renderPreview();
    });
    $("btnGmail").addEventListener("click", ()=>{
      window.open("https://docs.google.com/document/d/1rwJR7VNI9PRI4qNyL5AO1308kTgkb6Y-ntX6AZaaSGc/edit?usp=sharing", "_blank", "noopener,noreferrer");
    });

    $("btnDescargarPng").addEventListener("click", async ()=>{
      const ok = renderPreview();
      if(!ok) return;

      if (typeof html2canvas === "undefined") {
        alert("No se pudo cargar html2canvas. Revisa conexión o usa una versión local.");
        return;
      }

      const data = getData();

      const host = document.createElement("div");
      host.className = "captureHost";
      host.innerHTML = buildFirmaHTML(data, true);
      document.body.appendChild(host);

      try{
        const node = host.firstElementChild;
        const canvas = await html2canvas(node, {
          backgroundColor: "#ffffff",
          scale: 2,
          useCORS: true,
          windowWidth: node.scrollWidth,
          windowHeight: node.scrollHeight
        });
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = "firma-cafe-las-flores.png";
        a.click();
      } finally {
        host.remove();
      }
    });

    // Mensaje inicial en la vista previa
    $("sigPreview").innerHTML = `<div style="color:#6b7280;font-size:13px;">Completa <b>Nombre, Cargo, Teléfono y Dirección</b> y presiona “Generar”.</div>`;
  </script>
</body>
</html>




